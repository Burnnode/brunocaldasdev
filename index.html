<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SANYZATION - Adivinhe o Personagem</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- 3. TODO O CSS (Estilos com Design 2025) -->
    <style>
        /* --- Reset Básico e Tema Escuro --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Fundo preto sólido */
            color: #E0E0E0;
            display: flex;
            min-height: 100vh;
            overflow: hidden; /* Impede o scroll da página inteira */
        }

        /* O RASTRO/BRILHO DO MOUSE FOI REMOVIDO DAQUI */

        /* Layout de App com Sidebar */
        .app-layout {
            display: grid;
            grid-template-columns: 280px 1fr; /* Sidebar fixa, conteúdo flexível */
            width: 100%;
            height: 100vh;
        }

        /* Barra Lateral de Navegação */
        #sidebar {
            background-color: rgba(10, 0, 0, 0.75); /* Vidro fosco vermelho-preto */
            backdrop-filter: blur(12px) saturate(140%);
            border-right: 1px solid #6b1a1a;
            box-shadow: 0 0 20px rgba(229, 62, 62, 0.1);
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%;
            overflow-y: auto;
            z-index: 100; 
        }

        /* (MUDANÇA) Estilo do Logo na Sidebar */
        .sidebar-logo {
            width: 90%;
            max-width: 220px;
            margin: 0 auto 20px auto;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .sidebar-logo:hover {
            transform: scale(1.05);
        }

        .modo-botao {
            background-color: transparent;
            border: 1px solid #6b1a1a;
            border-radius: 8px;
            padding: 20px;
            text-decoration: none;
            color: #E0E0E0;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            text-align: left;
        }
        .modo-botao:hover {
            transform: scale(1.03);
            border-color: #E53E3E;
            background-color: #2a0a0a;
            box-shadow: 0 5px 20px rgba(229, 62, 62, 0.2);
        }
        .modo-botao h2 { font-size: 1.2rem; margin-bottom: 5px; }
        .modo-botao p { font-size: 0.9rem; color: #A0AEC0; }
        .modo-botao.maratona h2 { color: #ffc400; }
        
        .modo-botao.ativo {
            border-left: 4px solid #E53E3E;
            background-color: #2a0a0a;
        }

        /* Área de Conteúdo Principal (Direita) */
        #main-content {
            height: 100vh;
            overflow-y: auto;
            padding: 40px;
            
            background-image: 
                url('https://eqisfdigrutdfhrfyjly.supabase.co/storage/v1/object/public/personagens/capa%20do%20SANYDLE%20(1).png');
            background-size: cover;
            background-position: center top; 
            background-attachment: fixed;
            background-repeat: no-repeat;
            
            display: flex;
            justify-content: center;
        }

        .pagina {
            width: 100%;
            max-width: 800px;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            
            background-color: rgba(10, 0, 0, 0.65);
            backdrop-filter: blur(10px) saturate(120%);
            padding: 20px 30px;
            border-radius: 12px;
            border: 1px solid #6b1a1a;
            box-shadow: 0 0 20px rgba(229, 62, 62, 0.1);

            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease-out, visibility 0.4s ease-out;
        }
        
        .pagina.visivel {
            display: flex;
            opacity: 1;
            visibility: visible;
        }

        /* Media query para telas menores (celular) */
        @media (max-width: 768px) {
            .app-layout {
                grid-template-columns: 1fr;
                height: auto;
                min-height: 100vh;
            }
            #sidebar {
                height: auto;
                border-right: none;
                border-bottom: 1px solid #6b1a1a;
                padding: 20px;
                z-index: 10; 
            }
            #main-content {
                height: auto;
                min-height: 100vh;
                padding: 20px;
            }
            .modo-selecao { grid-template-columns: 1fr; }
        }

        /* --- 2. Estilos da Tela de Jogo (Geral) --- */
        .tela-jogo-base { text-align: center; position: relative; } 
        
        .tela-jogo-base h1 { color: #E53E3E; font-size: 2.5rem; cursor: pointer; }
        .contador-acertos { font-size: 1.5rem; font-weight: bold; color: #38A169; margin-bottom: 10px; }
        .contador-acertos span { color: #E0E0E0; }

        .form-palpite-container { width: 100%; max-width: 500px; position: relative; }
        .campo-palpite {
            width: 100%;
            padding: 15px;
            font-size: 1rem;
            background-color: #2a0a0a;
            border: 1px solid #6b1a1a;
            color: #FFF;
            border-radius: 8px;
            outline: none;
            transition: all 0.3s ease;
        }
        .campo-palpite:focus { 
            border-color: #E53E3E;
            box-shadow: 0 0 10px rgba(229, 62, 62, 0.3);
        }
        .campo-palpite:disabled { background-color: #1A202C; cursor: not-allowed; }

        .sugestoes-autocomplete {
            position: absolute;
            width: 100%;
            background-color: #2a0a0a;
            border: 1px solid #6b1a1a;
            border-top: none;
            border-radius: 0 0 8px 8px;
            z-index: 10;
            max-height: 300px;
            overflow-y: auto;
        }
        .sugestao-item { padding: 12px 15px; color: #E0E0E0; cursor: pointer; text-align: left; }
        .sugestao-item:hover { background-color: #6b1a1a; }
        .sugestao-item:not(:last-child) { border-bottom: 1px solid #6b1a1a; }

        /* 2c. Grade de Palpites (Modo Original) */
        .grade-palpites { width: 100%; display: flex; flex-direction: column; gap: 8px; }
        .linha-palpite-header, .linha-palpite { display: grid; grid-template-columns: 2fr 1.5fr 1.5fr 1.5fr; gap: 8px; width: 100%; }

        @media (max-width: 600px) {
            .linha-palpite-header, .linha-palpite { grid-template-columns: 1fr; gap: 5px; }
            .linha-palpite-header { display: none; }
            .linha-palpite { grid-template-columns: 1fr; border: 1px solid #6b1a1a; border-radius: 8px; padding: 10px; }
            .celula { padding: 8px; display: flex; justify-content: center; white-space: normal; }
            .celula.nome::before { content: 'Nome: '; font-weight: bold; color: #A0AEC0; margin-right: 10px; }
            .celula.elemento::before { content: 'Elemento: '; font-weight: bold; color: #A0AEC0; margin-right: 10px; }
            .celula.temporada::before { content: 'Temporada: '; font-weight: bold; color: #A0AEC0; margin-right: 10px; }
            .celula.tipo::before { content: 'Tipo: '; font-weight: bold; color: #A0AEC0; margin-right: 10px; }
        }

        .linha-palpite-header .celula { background-color: transparent; font-weight: bold; color: #A0AEC0; font-size: 0.9rem; text-transform: uppercase; }
        .celula {
            padding: 10px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            white-space: normal;
            word-break: break-word;
            background-color: #441a1a; 
            color: #FFF;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            
            opacity: 0;
            transform: scale(0.9);
            animation: revealCell 0.5s ease forwards;
        }
        
        @keyframes revealCell {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .elemento-icon { width: 20px; height: 20px; flex-shrink: 0; }
        .celula.verde { background-color: #38A169; }
        .celula.amarelo { background-color: #D69E2E; }

        /* --- 3. ESTILOS DO MODO IMAGEM --- */
        .imagem-container { width: 100%; max-width: 500px; aspect-ratio: 1 / 1; background-color: #1A202C; border-radius: 8px; overflow: hidden; border: 1px solid #6b1a1a; margin-bottom: 20px; }
        
        #personagem-imagem-diario, #personagem-imagem-maratona {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: filter 0.5s ease-out;
        }

        .lista-palpites-imagem { width: 100%; max-width: 500px; display: flex; flex-direction: column; gap: 8px; }
        .item-palpite-imagem {
            background-color: #2a0a0a;
            border: 1px solid #6b1a1a;
            border-radius: 6px;
            padding: 12px 15px;
            font-size: 1rem;
            text-align: center;
            color: #E0E0E0;
            opacity: 0;
            transform: scale(0.9);
            animation: revealCell 0.5s ease forwards;
        }
        .item-palpite-imagem.correto { background-color: #38A169; border-color: #2F855A; font-weight: bold; }

        /* --- 4. Modal de Mensagem (Toast) --- */
        #modal-mensagem { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #2D3748; color: white; padding: 15px 25px; border-radius: 8px; border: 1px solid #4A5568; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; pointer-events: none; }
        #modal-mensagem.vitoria { background-color: #38A169; border-color: #2F855A; }
        #modal-mensagem.erro { background-color: #C53030; border-color: #9B2C2C; }
        #modal-mensagem.visivel { opacity: 1; visibility: visible; }

        /* --- 5. TELA DE VITÓRIA --- */
        #tela-vitoria {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(10, 0, 0, 0.95); 
            z-index: 2000;
            display: none;
            justify-content: center; align-items: center;
            flex-direction: column;
            text-align: center;
            opacity: 0; visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        #tela-vitoria.visivel { display: flex; opacity: 1; visibility: visible; }
        #tela-vitoria h2 { font-size: 4rem; color: #38A169; margin-bottom: 20px; }
        #vitoria-texto { font-size: 1.2rem; color: #A0AEC0; margin-bottom: 40px; }
        #btn-voltar-menu { background-color: #E53E3E; color: #FFF; padding: 15px 30px; font-size: 1.1rem; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        #btn-voltar-menu:hover { background-color: #C53030; }
    </style>
</head>

<body>

    <!-- Rastro/Brilho do Mouse REMOVIDO -->

    <!-- Layout do App -->
    <div class="app-layout">
        
        <!-- Sidebar de Navegação -->
        <nav id="sidebar">
            
            <!-- (MUDANÇA FEITA) H1 Trocado por IMG -->
            <img src="https://eqisfdigrutdfhrfyjly.supabase.co/storage/v1/object/public/personagens/menu.png" 
                 alt="Sanyzation Logo" 
                 class="sidebar-logo"
                 id="logo-para-menu"> <!-- (NOVO ID) -->
            
            <div class="modo-botao" id="btn-iniciar-original-diario">
                <h2>Modo Original</h2>
                <p>O desafio diário. (1 Acerto)</p>
            </div>
            <div class="modo-botao" id="btn-iniciar-imagem-diario">
                <h2>Modo Imagem</h2>
                <p>O desafio diário com imagem. (1 Acerto)</p>
            </div>
            <div class="modo-botao maratona" id="btn-iniciar-original-maratona">
                <h2>Maratona Original</h2>
                <p>Acerte 20 personagens seguidos!</p>
            </div>
            <div class="modo-botao maratona" id="btn-iniciar-imagem-maratona">
                <h2>Maratona Imagem</h2>
                <p>Acerte 20 imagens seguidas!</p>
            </div>
        </nav>
        
        <!-- Conteúdo Principal (Direita) -->
        <main id="main-content">

            <!-- 7. HTML - TELAS DE JOGO (Agora dentro do main-content) -->

            <!-- 7a. Jogo Original (Diário) -->
            <div id="tela-jogo-original-diario" class="pagina tela-jogo-base">
                <h2>Desafio Diário - Original</h2>
                <form id="form-palpite-original-diario" class="form-palpite-container" onsubmit="return false;">
                    <input type="text" id="campo-palpite-original-diario" class="campo-palpite" placeholder="Carregando..." autocomplete="off" disabled>
                    <div id="sugestoes-autocomplete-original-diario" class="sugestoes-autocomplete"></div>
                </form>
                <div id="grade-palpites-original-diario" class="grade-palpites">
                    <div class="linha-palpite-header">
                        <div class="celula">Personagem</div><div class="celula">Elemento</div><div class="celula">Temporada</div><div class="celula">Tipo</div>
                    </div>
                </div>
            </div>
            
            <!-- 7b. Jogo Imagem (Diário) -->
            <div id="tela-jogo-imagem-diario" class="pagina tela-jogo-base">
                <h2>Desafio Diário - Imagem</h2>
                <div class="imagem-container">
                    <img id="personagem-imagem-diario" src="" alt="Personagem Secreto Borrado">
                </div>
                <form id="form-palpite-imagem-diario" class="form-palpite-container" onsubmit="return false;">
                    <input type="text" id="campo-palpite-imagem-diario" class="campo-palpite" placeholder="Carregando..." autocomplete="off" disabled>
                    <div id="sugestoes-autocomplete-imagem-diario" class="sugestoes-autocomplete"></div>
                </form>
                <div id="lista-palpites-imagem-diario" class="lista-palpites-imagem"></div>
            </div>
            
            <!-- 7c. Jogo Original (Maratona) -->
            <div id="tela-jogo-original-maratona" class="pagina tela-jogo-base">
                <h2>Maratona Original</h2>
                <div id="contador-original-maratona" class="contador-acertos">0 <span>/ 20</span></div>
                <form id="form-palpite-original-maratona" class="form-palpite-container" onsubmit="return false;">
                    <input type="text" id="campo-palpite-original-maratona" class="campo-palpite" placeholder="Carregando..." autocomplete="off" disabled>
                    <div id="sugestoes-autocomplete-original-maratona" class="sugestoes-autocomplete"></div>
                </form>
                <div id="grade-palpites-original-maratona" class="grade-palpites">
                    <div class="linha-palpite-header">
                        <div class="celula">Personagem</div><div class="celula">Elemento</div><div class="celula">Temporada</div><div class="celula">Tipo</div>
                    </div>
                </div>
            </div>
            
            <!-- 7d. Jogo Imagem (Maratona) -->
            <div id="tela-jogo-imagem-maratona" class="pagina tela-jogo-base">
                <h2>Maratona Imagem</h2>
                <div id="contador-imagem-maratona" class="contador-acertos">0 <span>/ 20</span></div>
                <div class="imagem-container">
                    <img id="personagem-imagem-maratona" src="" alt="Personagem Aleatório Borrado">
                </div>
                <form id="form-palpite-imagem-maratona" class="form-palpite-container" onsubmit="return false;">
                    <input type="text" id="campo-palpite-imagem-maratona" class="campo-palpite" placeholder="Carregando..." autocomplete="off" disabled>
                    <div id="sugestoes-autocomplete-imagem-maratona" class="sugestoes-autocomplete"></div>
                </form>
                <div id="lista-palpites-imagem-maratona" class="lista-palpites-imagem"></div>
            </div>

        </main> <!-- Fim do #main-content -->

    </div> <!-- Fim do .app-layout -->
    
    <!-- 8. HTML - Modal de Mensagem (Toast) -->
    <div id="modal-mensagem"><span id="modal-texto"></span></div>

    <!-- 9. HTML - TELA DE VITÓRIA -->
    <div id="tela-vitoria" class="pagina">
        <h2>Parabéns!</h2>
        <p id="vitoria-texto">Você completou o desafio!</p>
        <button id="btn-voltar-menu">Voltar ao Menu</button>
    </div>


    <!-- 10. TODO O JAVASCRIPT (Lógica Corrigida) -->
    <script>
        // --- 1. CONFIGURAÇÃO SUPABASE ---
        const SUPABASE_URL = 'https://eqisfdigrutdfhrfyjly.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxaXNmZGlncnV0ZGZocmZ5amx5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNjUwOTAsImV4cCI6MjA3Nzg0MTA5MH0.MuWpaRzm3tUsLwJjCh8ji2LOG599NR5vl0yAFtpHoTU';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        const iconesElementos = {
            'Conhecimento': 'https://eqisfdigrutdfhrfyjly.supabase.co/storage/v1/object/public/personagens/conhecimento.webp',
            'Energia': 'https://eqisfdigrutdfhrfyjly.supabase.co/storage/v1/object/public/personagens/energia.webp',
            'Medo': 'https://eqisfdigrutdfhrfyjly.supabase.co/storage/v1/object/public/personagens/medo.png',
            'Sangue': 'https://eqisfdigrutdfhrfyjly.supabase.co/storage/v1/object/public/personagens/sangue.webp',
            'Morte': 'https://eqisfdigrutdfhrfyjly.supabase.co/storage/v1/object/public/personagens/morte.webp',
            'Todos': '', 
            'N/A': '',
            'Sangue / Conhecimento': '' 
        };

        // --- (CORREÇÃO CRÍTICA) Envolve TUDO em DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- 2. ELEMENTOS GLOBAIS ---
            const todasAsPaginas = document.querySelectorAll('.pagina');
            const modalMensagem = document.getElementById('modal-mensagem');
            const modalTexto = document.getElementById('modal-texto');
            const telaVitoria = document.getElementById('tela-vitoria');
            const vitoriaTexto = document.getElementById('vitoria-texto');
            const btnVoltarMenu = document.getElementById('btn-voltar-menu');

            // --- 3. ELEMENTOS DOS MODOS ---
            const todosOsBotoesDeModo = document.querySelectorAll('.modo-botao'); 
            const btnIniciarOriginalDiario = document.getElementById('btn-iniciar-original-diario');
            const btnIniciarImagemDiario = document.getElementById('btn-iniciar-imagem-diario');
            const btnIniciarOriginalMaratona = document.getElementById('btn-iniciar-original-maratona');
            const btnIniciarImagemMaratona = document.getElementById('btn-iniciar-imagem-maratona');
            
            // (NOVO) Botão do Logo
            const logoBtn = document.getElementById('logo-para-menu');
            
            const telaJogoOriginalDiario = document.getElementById('tela-jogo-original-diario');
            const inputOriginalDiario = document.getElementById('campo-palpite-original-diario');
            const formOriginalDiario = document.getElementById('form-palpite-original-diario');
            const sugestoesOriginalDiario = document.getElementById('sugestoes-autocomplete-original-diario');
            const gradeOriginalDiario = document.getElementById('grade-palpites-original-diario');

            const telaJogoImagemDiario = document.getElementById('tela-jogo-imagem-diario');
            const inputImagemDiario = document.getElementById('campo-palpite-imagem-diario');
            const formImagemDiario = document.getElementById('form-palpite-imagem-diario');
            const sugestoesImagemDiario = document.getElementById('sugestoes-autocomplete-imagem-diario');
            const imgImagemDiario = document.getElementById('personagem-imagem-diario');
            const listaImagemDiario = document.getElementById('lista-palpites-imagem-diario');
            
            const telaJogoOriginalMaratona = document.getElementById('tela-jogo-original-maratona');
            const inputOriginalMaratona = document.getElementById('campo-palpite-original-maratona');
            const formOriginalMaratona = document.getElementById('form-palpite-original-maratona');
            const sugestoesOriginalMaratona = document.getElementById('sugestoes-autocomplete-original-maratona');
            const gradeOriginalMaratona = document.getElementById('grade-palpites-original-maratona');
            const contadorOriginalMaratona = document.getElementById('contador-original-maratona');

            const telaJogoImagemMaratona = document.getElementById('tela-jogo-imagem-maratona');
            const inputImagemMaratona = document.getElementById('campo-palpite-imagem-maratona');
            const formImagemMaratona = document.getElementById('form-palpite-imagem-maratona');
            const sugestoesImagemMaratona = document.getElementById('sugestoes-autocomplete-imagem-maratona');
            const imgImagemMaratona = document.getElementById('personagem-imagem-maratona');
            const listaImagemMaratona = document.getElementById('lista-palpites-imagem-maratona');
            const contadorImagemMaratona = document.getElementById('contador-imagem-maratona');

            // --- 5. VARIÁVEIS GLOBAIS DO JOGO ---
            let personagemSecretoOriginal = null;
            let personagemSecretoImagem = null;
            let personagemMaratonaAtual = null;
            let jogoCarregado = false;
            let debounceTimeout;
            
            let jogoOriginalDiarioEmAndamento = true;
            let jogoImagemDiarioEmAndamento = true;
            let palpitesImagemDiarioRestantes = 5;
            
            let jogoOriginalMaratonaEmAndamento = true;
            let jogoImagemMaratonaEmAndamento = true;
            let acertosMaratonaOriginal = 0;
            let acertosMaratonaImagem = 0;
            const META_ACERTOS = 20;

            const BLUR_INICIAL = 20;
            const BLUR_REDUCAO = 4;

            // --- 6. NAVEGAÇÃO E INICIALIZAÇÃO ---

            function mostrarTela(idTela, botaoAtivo) {
                todasAsPaginas.forEach(pagina => {
                    pagina.classList.remove('visivel');
                });
                todosOsBotoesDeModo.forEach(btn => {
                    btn.classList.remove('ativo');
                });
                
                const telaParaMostrar = document.getElementById(idTela);
                if (telaParaMostrar) {
                    telaParaMostrar.classList.add('visivel');
                    if (botaoAtivo) {
                        botaoAtivo.classList.add('ativo');
                    }
                } else {
                    telaJogoOriginalDiario.classList.add('visivel');
                    btnIniciarOriginalDiario.classList.add('ativo');
                }
            }
            
            btnVoltarMenu.addEventListener('click', () => {
                 telaVitoria.classList.remove('visivel');
                 mostrarTela('tela-jogo-original-diario', btnIniciarOriginalDiario);
                 initModoOriginalDiario();
            });

            // (NOVO) Click do Logo
            logoBtn.addEventListener('click', () => {
                mostrarTela('tela-jogo-original-diario', btnIniciarOriginalDiario);
                initModoOriginalDiario();
            });

            btnIniciarOriginalDiario.addEventListener('click', (e) => {
                mostrarTela('tela-jogo-original-diario', e.currentTarget);
                if (!jogoCarregado) carregarJogosDiarios().then(initModoOriginalDiario);
                else initModoOriginalDiario();
            });
            
            btnIniciarImagemDiario.addEventListener('click', (e) => {
                mostrarTela('tela-jogo-imagem-diario', e.currentTarget);
                if (!jogoCarregado) carregarJogosDiarios().then(initModoImagemDiario);
                else initModoImagemDiario();
            });

            btnIniciarOriginalMaratona.addEventListener('click', (e) => {
                mostrarTela('tela-jogo-original-maratona', e.currentTarget);
                initMaratonaOriginal();
            });
            
            btnIniciarImagemMaratona.addEventListener('click', (e) => {
                mostrarTela('tela-jogo-imagem-maratona', e.currentTarget);
                initMaratonaImagem();
            });

            async function carregarJogosDiarios() {
                if (jogoCarregado) return;
                
                inputOriginalDiario.disabled = true;
                inputImagemDiario.disabled = true;
                inputOriginalDiario.placeholder = 'Carregando personagem do dia...';
                inputImagemDiario.placeholder = 'Carregando personagem do dia...';

                const [respOriginal, respImagem] = await Promise.all([
                    supabaseClient.rpc('get_daily_personagem'),
                    supabaseClient.rpc('get_daily_personagem_imagem')
                ]);

                let erro = false;
                if (respOriginal.error || !respOriginal.data || respOriginal.data.length === 0) {
                    console.error('Erro ao buscar personagem original:', respOriginal.error);
                    mostrarMensagem('Erro ao carregar o jogo (Original).', 'erro');
                    erro = true;
                }
                if (respImagem.error || !respImagem.data || respImagem.data.length === 0) {
                    console.error('Erro ao buscar personagem imagem:', respImagem.error);
                    mostrarMensagem('Erro: O personagem diário de imagem (função: get_daily_personagem_imagem) não foi encontrado. Verifique se você tem personagens com imagens válidas no DB.', 'erro');
                    erro = true;
                }

                if (erro) return;

                personagemSecretoOriginal = respOriginal.data[0];
                personagemSecretoImagem = respImagem.data[0];
                jogoCarregado = true;
                
                console.log("Secreto Original:", personagemSecretoOriginal.nome_personagem);
                console.log("Secreto Imagem:", personagemSecretoImagem.nome_personagem);
                
                inputOriginalDiario.disabled = false;
                inputImagemDiario.disabled = false;
                inputOriginalDiario.placeholder = 'Digite o nome do personagem...';
                inputImagemDiario.placeholder = 'Digite o nome do personagem...';
            }
            
            // --- 7. LÓGICA MODO ORIGINAL (DIÁRIO) ---

            function initModoOriginalDiario() {
                while (gradeOriginalDiario.children.length > 1) {
                    gradeOriginalDiario.removeChild(gradeOriginalDiario.lastChild);
                }
                jogoOriginalDiarioEmAndamento = true;
                inputOriginalDiario.disabled = false;
                inputOriginalDiario.placeholder = 'Digite o nome do personagem...';
                inputOriginalDiario.value = '';
                inputOriginalDiario.focus();
            }
            
            async function processarPalpiteOriginalDiario(nomeCompleto, nomeLimpo) {
                if (!jogoOriginalDiarioEmAndamento) return;
                const palpiteEncontrado = await buscarDadosPersonagemPrincipal(nomeLimpo);
                const feedback = criarFeedback(nomeCompleto, palpiteEncontrado, personagemSecretoOriginal);
                criarLinhaDePalpiteGrade(feedback, gradeOriginalDiario);
                if (feedback.vitoria) {
                    mostrarTelaVitoria('diário original');
                    jogoOriginalDiarioEmAndamento = false;
                    inputOriginalDiario.disabled = true;
                    inputOriginalDiario.placeholder = 'Personagem encontrado!';
                }
                inputOriginalDiario.value = '';
            }

            // --- 8. LÓGICA MODO IMAGEM (DIÁRIO) ---
            
            function initModoImagemDiario() {
                listaImagemDiario.innerHTML = '';
                jogoImagemDiarioEmAndamento = true;
                palpitesImagemDiarioRestantes = 5;
                inputImagemDiario.disabled = false;
                inputImagemDiario.placeholder = 'Digite o nome do personagem...';
                inputImagemDiario.value = '';
                
                if (personagemSecretoImagem && personagemSecretoImagem.url_imagem && personagemSecretoImagem.url_imagem !== '#PENDENTE') {
                    imgImagemDiario.src = personagemSecretoImagem.url_imagem;
                    imgImagemDiario.style.filter = `blur(${BLUR_INICIAL}px)`;
                } else {
                    imgImagemDiario.src = '';
                    imgImagemDiario.alt = "Erro: Imagem não encontrada para este personagem.";
                    mostrarMensagem('Personagem do dia não tem imagem. Tente outro modo.', 'erro');
                    inputImagemDiario.disabled = true;
                }
                inputImagemDiario.focus();
            }
            
            async function processarPalpiteImagemDiario(nomeCompleto, nomeLimpo) {
                if (!jogoImagemDiarioEmAndamento) return;
                
                const itemPalpite = criarLinhaDePalpiteImagem(nomeCompleto);

                if (nomeLimpo === personagemSecretoImagem.nome_limpo) {
                    itemPalpite.classList.add('correto');
                    listaImagemDiario.appendChild(itemPalpite);
                    imgImagemDiario.style.filter = 'blur(0px)';
                    mostrarTelaVitoria('diário de imagem');
                    jogoImagemDiarioEmAndamento = false;
                    inputImagemDiario.disabled = true;
                    inputImagemDiario.placeholder = 'Personagem encontrado!';
                } else {
                    listaImagemDiario.appendChild(itemPalpite);
                    palpitesImagemDiarioRestantes--;

                    if (palpitesImagemDiarioRestantes <= 0) {
                        imgImagemDiario.style.filter = 'blur(0px)';
                        mostrarMensagem(`Fim de jogo! O personagem era ${personagemSecretoImagem.nome_personagem}`, 'erro');
                        jogoImagemDiarioEmAndamento = false;
                        inputImagemDiario.disabled = true;
                    } else {
                        const novoBlur = palpitesImagemDiarioRestantes * BLUR_REDUCAO;
                        imgImagemDiario.style.filter = `blur(${novoBlur}px)`;
                        mostrarMensagem(`Errado! ${palpitesImagemDiarioRestantes} chances restantes.`);
                    }
                }
                inputImagemDiario.value = '';
            }

            // --- 9. LÓGICA MARATONA ORIGINAL ---
            
            async function initMaratonaOriginal() {
                while (gradeOriginalMaratona.children.length > 1) {
                    gradeOriginalMaratona.removeChild(gradeOriginalMaratona.lastChild);
                }
                jogoOriginalMaratonaEmAndamento = true;
                acertosMaratonaOriginal = 0;
                contadorOriginalMaratona.innerHTML = `${acertosMaratonaOriginal} <span>/ ${META_ACERTOS}</span>`;
                inputOriginalMaratona.disabled = true;
                await carregarProximoDesafioMaratona('original');
                inputOriginalMaratona.disabled = false;
                inputOriginalMaratona.focus();
            }

            async function carregarProximoDesafioMaratona(modo) {
                const rpc = (modo === 'original') ? 'get_random_personagem_original' : 'get_random_personagem_imagem';
                const { data, error } = await supabaseClient.rpc(rpc);
                
                if (error || !data || data.length === 0) {
                    mostrarMensagem('Erro ao carregar próximo personagem.', 'erro');
                    return false;
                }
                personagemMaratonaAtual = data[0];
                console.log("Próximo desafio:", personagemMaratonaAtual.nome_personagem);

                if(modo === 'imagem') {
                    if (personagemMaratonaAtual.url_imagem && personagemMaratonaAtual.url_imagem !== '#PENDENTE') {
                        imgImagemMaratona.src = personagemMaratonaAtual.url_imagem;
                        imgImagemMaratona.style.filter = `blur(${BLUR_INICIAL}px)`;
                        listaImagemMaratona.innerHTML = '';
                        palpitesImagemRestantes = 5;
                    } else {
                        return carregarProximoDesafioMaratona('imagem');
                    }
                }
                return true;
            }
            
            async function processarPalpiteMaratonaOriginal(nomeCompleto, nomeLimpo) {
                if (!jogoOriginalMaratonaEmAndamento) return;
                const palpiteEncontrado = await buscarDadosPersonagemPrincipal(nomeLimpo);
                const feedback = criarFeedback(nomeCompleto, palpiteEncontrado, personagemMaratonaAtual);
                criarLinhaDePalpiteGrade(feedback, gradeOriginalMaratona);
                inputOriginalMaratona.value = '';

                if (feedback.vitoria) {
                    acertosMaratonaOriginal++;
                    contadorOriginalMaratona.innerHTML = `${acertosMaratonaOriginal} <span>/ ${META_ACERTOS}</span>`;
                    
                    if (acertosMaratonaOriginal >= META_ACERTOS) {
                        mostrarTelaVitoria('Maratona Original');
                        jogoOriginalMaratonaEmAndamento = false;
                        inputOriginalMaratona.disabled = true;
                    } else {
                        mostrarMensagem(`Correto! Próximo... (${acertosMaratonaOriginal}/${META_ACERTOS})`, 'vitoria');
                        inputOriginalMaratona.disabled = true;
                         setTimeout(async () => {
                            while (gradeOriginalMaratona.children.length > 1) {
                                gradeOriginalMaratona.removeChild(gradeOriginalMaratona.lastChild);
                            }
                            await carregarProximoDesafioMaratona('original');
                            inputOriginalMaratona.disabled = false;
                            inputOriginalMaratona.focus();
                        }, 1500);
                    }
                }
            }

            // --- 10. LÓGICA MARATONA IMAGEM ---
            
            async function initMaratonaImagem() {
                listaImagemMaratona.innerHTML = '';
                jogoImagemMaratonaEmAndamento = true;
                acertosMaratonaImagem = 0;
                contadorImagemMaratona.innerHTML = `${acertosMaratonaImagem} <span>/ ${META_ACERTOS}</span>`;
                inputImagemMaratona.disabled = true;
                await carregarProximoDesafioMaratona('imagem');
                inputImagemMaratona.disabled = false;
                inputImagemMaratona.focus();
            }
            
            async function processarPalpiteMaratonaImagem(nomeCompleto, nomeLimpo) {
                if (!jogoImagemMaratonaEmAndamento) return;
                
                const itemPalpite = criarLinhaDePalpiteImagem(nomeCompleto);
                listaImagemMaratona.appendChild(itemPalpite);
                inputImagemMaratona.value = '';

                if (nomeLimpo === personagemMaratonaAtual.nome_limpo) {
                    itemPalpite.classList.add('correto');
                    imgImagemMaratona.style.filter = 'blur(0px)';
                    acertosMaratonaImagem++;
                    contadorImagemMaratona.innerHTML = `${acertosMaratonaImagem} <span>/ ${META_ACERTOS}</span>`;

                    if (acertosMaratonaImagem >= META_ACERTOS) {
                        mostrarTelaVitoria('Maratona de Imagem');
                        jogoImagemMaratonaEmAndamento = false;
                        inputImagemMaratona.disabled = true;
                    } else {
                        mostrarMensagem(`Correto! Próximo... (${acertosMaratonaImagem}/${META_ACERTOS})`, 'vitoria');
                        inputImagemMaratona.disabled = true;
                        setTimeout(async () => {
                            await carregarProximoDesafioMaratona('imagem');
                            inputImagemMaratona.disabled = false;
                            inputImagemMaratona.focus();
                        }, 1500);
                    }

                } else {
                    palpitesImagemRestantes--;

                    if (palpitesImagemRestantes <= 0) {
                        imgImagemMaratona.style.filter = 'blur(0px)';
                        mostrarMensagem(`Errado! O personagem era ${personagemMaratonaAtual.nome_personagem}. A contagem foi reiniciada!`, 'erro');
                        acertosMaratonaImagem = 0;
                        contadorImagemMaratona.innerHTML = `${acertosMaratonaImagem} <span>/ ${META_ACERTOS}</span>`;
                        
                        inputImagemMaratona.disabled = true;
                        setTimeout(async () => {
                            await carregarProximoDesafioMaratona('imagem');
                            inputImagemMaratona.disabled = false;
                            inputImagemMaratona.focus();
                        }, 2500);

                    } else {
                        const novoBlur = palpitesImagemRestantes * BLUR_REDUCAO;
                        imgImagemMaratona.style.filter = `blur(${novoBlur}px)`;
                        mostrarMensagem(`Errado! ${palpitesImagemRestantes} chances restantes.`);
                    }
                }
            }

            // --- 11. FUNÇÕES UTILITÁRIAS COMPARTILHADAS ---

            function normalizarTexto(texto) {
                return texto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, '');
            }
            
            async function buscarDadosPersonagemPrincipal(nomeLimpo) {
                 const { data, error } = await supabaseClient.from('personagens_ordem').select('*').eq('nome_limpo', nomeLimpo).single();
                return (error || !data) ? null : data;
            }

            function handleAutocomplete(termo, containerSugestoes, onSelectCallback) {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(async () => {
                    if (termo.length < 2) {
                        limparSugestoes(containerSugestoes);
                        return;
                    }
                    
                    const termoLimpo = normalizarTexto(termo);
                    const { data, error } = await supabaseClient.from('personagens_autocompletar').select('nome_completo, nome_limpo').ilike('nome_limpo', `%${termoLimpo}%`).limit(8);

                    if (error) { console.error("Erro ao buscar sugestões:", error); return; }
                    
                    exibirSugestoes(data, containerSugestoes, onSelectCallback);
                }, 250);
            }

            function exibirSugestoes(sugestoes, container, onSelectCallback) {
                limparSugestoes(container);
                sugestoes.forEach(personagem => {
                    const item = document.createElement('div');
                    item.classList.add('sugestao-item');
                    item.textContent = personagem.nome_completo;
                    item.addEventListener('click', () => {
                        limparSugestoes(container);
                        onSelectCallback(personagem.nome_completo, personagem.nome_limpo);
                    });
                    container.appendChild(item);
                });
            }

            function limparSugestoes(container) { container.innerHTML = ''; }
            
            function mostrarMensagem(texto, tipo = '') {
                 modalTexto.textContent = texto;
                 modalMensagem.className = '';
                 modalMensagem.classList.add('visivel');
                 if (tipo) modalMensagem.classList.add(tipo);
                 setTimeout(() => { modalMensagem.classList.remove('visivel'); }, 2500);
            }
            
            function criarFeedback(nomeCompleto, palpiteEncontrado, personagemSecreto) {
                const feedback = {
                    nome: { valor: nomeCompleto, status: 'cinza' },
                    elemento: { valor: '???', status: 'cinza' },
                    temporada: { valor: '???', status: 'cinza' },
                    tipo: { valor: '???', status: 'cinza' },
                    vitoria: false
                };

                if (palpiteEncontrado && personagemSecreto) {
                    feedback.elemento.valor = palpiteEncontrado.elemento_principal;
                    feedback.temporada.valor = palpiteEncontrado.temporada_estreia;
                    feedback.tipo.valor = palpiteEncontrado.tipo_personagem;

                    if (palpiteEncontrado.elemento_principal === personagemSecreto.elemento_principal) feedback.elemento.status = 'verde';
                    else if (personagemSecreto.elemento_principal.includes(palpiteEncontrado.elemento_principal)) feedback.elemento.status = 'amarelo';
                    
                    if (palpiteEncontrado.temporada_estreia === personagemSecreto.temporada_estreia) feedback.temporada.status = 'verde';
                    if (palpiteEncontrado.tipo_personagem === personagemSecreto.tipo_personagem) feedback.tipo.status = 'verde';

                    if (palpiteEncontrado.nome_limpo === personagemSecreto.nome_limpo) {
                        feedback.vitoria = true;
                        feedback.nome.status = 'verde';
                        feedback.elemento.status = 'verde';
                        feedback.temporada.status = 'verde';
                        feedback.tipo.status = 'verde';
                    }
                }
                return feedback;
            }

            function criarLinhaDePalpiteGrade(feedback, gradeElement) {
                const novaLinha = document.createElement('div');
                novaLinha.classList.add('linha-palpite');
                
                let iconeHtml = '';
                const elementoValor = feedback.elemento.valor;

                if (iconesElementos[elementoValor]) {
                    iconeHtml = `<img src="${iconesElementos[elementoValor]}" class="elemento-icon" alt="${elementoValor}">`;
                } else if (elementoValor === 'Sangue / Conhecimento') {
                    iconeHtml = `<img src="${iconesElementos['Sangue']}" class="elemento-icon" alt="Sangue">
                                 <img src="${iconesElementos['Conhecimento']}" class="elemento-icon" alt="Conhecimento">`;
                }

                novaLinha.innerHTML = `
                    <div class="celula nome ${feedback.nome.status}">${feedback.nome.valor}</div>
                    <div class="celula elemento ${feedback.elemento.status}">
                        ${iconeHtml}
                        <span>${feedback.elemento.valor}</span>
                    </div>
                    <div class="celula temporada ${feedback.temporada.status}">${feedback.temporada.valor}</div>
                    <div class="celula tipo ${feedback.tipo.status}">${feedback.tipo.valor}</div>
                `;
                
                gradeElement.appendChild(novaLinha);

                const cells = novaLinha.querySelectorAll('.celula');
                cells.forEach((cell, index) => {
                    cell.style.animationDelay = `${index * 0.1}s`;
                });
            }

            function criarLinhaDePalpiteImagem(nomeCompleto) {
                const itemPalpite = document.createElement('div');
                itemPalpite.classList.add('item-palpite-imagem');
                itemPalpite.textContent = nomeCompleto;
                return itemPalpite;
            }

            function mostrarTelaVitoria(modo) {
                vitoriaTexto.textContent = `Você completou o desafio: ${modo}!`;
                telaVitoria.classList.add('visivel');
            }
            
            // --- (CORREÇÃO) ADICIONA OS OUVINTES DE EVENTO QUE FALTAVAM ---
            
            inputOriginalDiario.addEventListener('input', (e) => {
                handleAutocomplete(e.target.value, sugestoesOriginalDiario, (nomeCompleto, nomeLimpo) => {
                    inputOriginalDiario.value = nomeCompleto;
                    processarPalpiteOriginalDiario(nomeCompleto, nomeLimpo);
                });
            });
            formOriginalDiario.addEventListener('submit', (e) => {
                e.preventDefault(); if (!jogoOriginalDiarioEmAndamento) return;
                const palpiteCompleto = inputOriginalDiario.value;
                if (palpiteCompleto && palpiteCompleto.length > 2) {
                    const nomeLimpo = normalizarTexto(palpiteCompleto);
                    limparSugestoes(sugestoesOriginalDiario);
                    processarPalpiteOriginalDiario(palpiteCompleto, nomeLimpo);
                }
            });
            
            inputImagemDiario.addEventListener('input', (e) => {
                handleAutocomplete(e.target.value, sugestoesImagemDiario, (nomeCompleto, nomeLimpo) => {
                    inputImagemDiario.value = nomeCompleto;
                    processarPalpiteImagemDiario(nomeCompleto, nomeLimpo);
                });
            });
            formImagemDiario.addEventListener('submit', (e) => {
                e.preventDefault(); if (!jogoImagemDiarioEmAndamento) return;
                const palpiteCompleto = inputImagemDiario.value;
                if (palpiteCompleto && palpiteCompleto.length > 2) {
                    const nomeLimpo = normalizarTexto(palpiteCompleto);
                    limparSugestoes(sugestoesImagemDiario);
                    processarPalpiteImagemDiario(palpiteCompleto, nomeLimpo);
                }
            });

            inputOriginalMaratona.addEventListener('input', (e) => {
                handleAutocomplete(e.target.value, sugestoesOriginalMaratona, (nomeCompleto, nomeLimpo) => {
                    inputOriginalMaratona.value = nomeCompleto;
                    processarPalpiteMaratonaOriginal(nomeCompleto, nomeLimpo);
                });
            });
            formOriginalMaratona.addEventListener('submit', (e) => {
                e.preventDefault(); if (!jogoOriginalMaratonaEmAndamento) return;
                const palpiteCompleto = inputOriginalMaratona.value;
                if (palpiteCompleto && palpiteCompleto.length > 2) {
                    const nomeLimpo = normalizarTexto(palpiteCompleto);
                    limparSugestoes(sugestoesOriginalMaratona);
                    processarPalpiteMaratonaOriginal(palpiteCompleto, nomeLimpo);
                }
            });

            inputImagemMaratona.addEventListener('input', (e) => {
                handleAutocomplete(e.target.value, sugestoesImagemMaratona, (nomeCompleto, nomeLimpo) => {
                    inputImagemMaratona.value = nomeCompleto;
                    processarPalpiteMaratonaImagem(nomeCompleto, nomeLimpo);
                });
            });
            formImagemMaratona.addEventListener('submit', (e) => {
                e.preventDefault(); if (!jogoImagemMaratonaEmAndamento) return;
                const palpiteCompleto = inputImagemMaratona.value;
                if (palpiteCompleto && palpiteCompleto.length > 2) {
                    const nomeLimpo = normalizarTexto(palpiteCompleto);
                    limparSugestoes(sugestoesImagemMaratona);
                    processarPalpiteMaratonaImagem(palpiteCompleto, nomeLimpo);
                }
            });

            // --- FIM DOS OUVINTES DE EVENTO ---


            // --- INICIALIZAÇÃO DO JOGO ---
            carregarJogosDiarios();
            mostrarTela('tela-jogo-original-diario', btnIniciarOriginalDiario);
            initModoOriginalDiario();
            
            // --- LÓGICA DO RASTRO DO MOUSE (Removida) ---
            
        }); // <-- FIM DO DOMContentLoaded
        
    </script>
</body>
</html>
